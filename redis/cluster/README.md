# 集群

Redis Sentinel为Redis提供高可用性，可以实现自动化的故障转移并通知应用方，从节点晋升为主节点的整个过程不需要人工干预。

![](../../.gitbook/assets/image%20%2828%29.png)

它负责持续监控主从节点的健康，当主节点挂掉时，自动选择一个最优的从节点切换为主节点。客户端来连接集群时，会首先连接 sentinel，通过 sentinel 来查询主节点的地址，然后再去连接主节点进行数据交互。当主节点发生故障时，客户端会重新向 sentinel 要地址，sentinel 会将最新的主节点地址告诉客户端。

## 消息丢失

Redis 主从采用异步复制，意味着当主节点挂掉时，从节点可能没有收到全部的同步消息，这部分未同步的消息就丢失了。如果主从延迟特别大，那么丢失的数据就可能会特别多。Sentinel 无法保证消息完全不丢失，但是也尽可能保证消息少丢失。

它有两个选项可以限制主从延迟过大

```text
#主节点必须至少有一个从节点在进行正常复制，否则就停止对外写服务，丧失可用性。
min-slaves-to-write 1 
#如果 10s 没有收到从节点的反馈，就意味着从节点同步不正常
min-slaves-max-lag 10
```

## 主从切换

* 连接池建立新连接时，会去查询主库地址，然后跟内存中的主库地址进行比对，如果变更了，就断开所有连接，重新使用新地址建立新连接。如果是旧的主库挂掉了，那么所有正在使用的连接都会被关闭，然后在重连时就会用上新地址。
* redis是在处理命令的时候捕获了一个特殊的异常ReadOnlyError，在这个异常里将所有的旧连接全部关闭了，后续指令就会进行重连。

## 功能

* 监控（Monitoring）：Sentinel会不断的检查你的主节点和从节点是否正常工作。 
* 通知（Notification）：被监控的Redis实例如果出现问题，Sentinel可以通过API（pub）通知系统管理员或者其他程序。 
* 自动故障转移（Automatic failover）：如果一个master离线，Sentinel会开始进行故障转移，master下的一个slave会被选为新的master，其他的slave会开始复制新的master。应用可以通过Redis服务的通知机制更新新的master地址。 
* 配置提供者（Configuration provider）：客户端可以把Sentinel作为权威的配置发布者来获得最新的master地址。如果发生了故障转移，Sentinel集群会通知客户端新的master地址，并刷新redis的配置。



